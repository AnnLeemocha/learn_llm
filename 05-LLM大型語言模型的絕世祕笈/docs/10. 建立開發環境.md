# å»ºç«‹é–‹ç™¼ç’°å¢ƒ
å»ºç«‹æ·±åº¦å­¸ç¿’çš„é–‹ç™¼ç’°å¢ƒï¼Œç„¡è«–æ˜¯é–‹ç™¼æ‡‰ç”¨é‚„æ˜¯è¨“ç·´æ¨¡å‹ï¼Œéƒ½æœ‰å„è‡ªçš„å¤§å‘è¦è¸©ã€‚
å°±ç®—ä¸€é–‹å§‹ç’°å¢ƒéƒ½å¼„çš„å¥½å¥½çš„ï¼Œä¹Ÿæœ‰å¯èƒ½ç”¨ä¸€é™£å­ä¹‹å¾Œè‡ªå·±çªç„¶çˆ†ç‚¸ã€‚

---

## ä½œæ¥­ç³»çµ±
å„ªå…ˆåº:
1. å°ä¼éµ Linux
    * ç­†è€…æ¨è–¦ä½¿ç”¨ Ubuntu ä½œç‚ºä¸Šæ‰‹ç”¨çš„ Linux ç’°å¢ƒã€‚
    * ç­†è€…åå¥½ä½¿ç”¨ KDE Plasma æ¡Œé¢ç’°å¢ƒï¼Œå› æ­¤æ˜¯é¸ç”¨ Kubuntu 22.04 ä½œç‚ºä½œæ¥­ç³»çµ±ã€‚(æ¡Œé¢ç’°å¢ƒçš„å½±éŸ¿ä¸å¤§)
    * å…©å°æ©Ÿå™¨:
      å¯ä»¥è€ƒæ…®ä¸€å°è£ Ubuntu Server åªæœ‰ç´”æ–‡å­—ä»‹é¢ï¼Œå¦å¤–ä¸€å°ç”¨ Windows é ç«¯éå»é–‹ç™¼ã€‚
    * ä¸€å°æ©Ÿå™¨:
      å¯ä»¥è€ƒæ…®è£é›™ç³»çµ±ã€‚
2. Windows çš„ WSL å­ç³»çµ± (æœ¬è³ªä¸Šä¹Ÿæ˜¯ä¸€ç¨® Linux ä½œæ¥­ç³»çµ±)

---

## NVIDIA é©…å‹•ç¨‹å¼
æ˜¯é‹è¡Œæ•´å€‹ ML ç›¸é—œé–‹ç™¼æ‡‰ç”¨æœ€åŸºç¤ä¹Ÿæœ€é‡è¦çš„ç¬¬ä¸€æ­¥ï¼Œå¦‚æœä½ æ˜¯ä½¿ç”¨æœ‰æ¡Œé¢ç’°å¢ƒçš„ Ubuntuï¼Œé€šå¸¸èƒ½åœ¨ç³»çµ±è¨­å®šæ‰¾åˆ° "Driver" ç›¸é—œçš„é é¢ã€‚
![image](https://hackmd.io/_uploads/Bkg426Rgex.png)
* éå¸¸å¤šé¸æ“‡ï¼Œå…¶ä¸­ 535, 525, 470 ä»£è¡¨çš„æ˜¯ Driver çš„ç‰ˆæœ¬ã€‚
    * å¦‚æœä½ æœ‰å‹‡æ°£çš„è©±å¯ä»¥é¸æ“‡æœ€æ–°ç‰ˆä¾†è£ï¼Œå¦‚æœè¿½æ±‚ç©©å®šçš„è©±ï¼Œé€šå¸¸é¸æ“‡æ¬¡æ–°çš„ç‰ˆæœ¬æœƒæ¯”è¼ƒå¥½ã€‚
    * å…¶æ¬¡æ˜¯å¦‚æœä½ è¦ä¿ç•™æ¡Œé¢ç’°å¢ƒï¼Œé‚£å°±ä¸è¦è£æœ‰ "Server" å­—æ¨£çš„ç‰ˆæœ¬ï¼Œé€šå¸¸é‚£æ˜¯çµ¦ç´”æ–‡å­—ç’°å¢ƒä½¿ç”¨çš„ã€‚
* ç´”æ–‡å­—ç’°å¢ƒä¸‹é€²è¡Œ NVIDIA Driver çš„å®‰è£
    * æŸ¥çœ‹å¯ä»¥å®‰è£çš„ Driver ç‰ˆæœ¬ï¼š
      ```bash
      apt search nvidia-driver
      # æˆ–è€… 
      apt-cache search nvidia-driver
      ```
    * é€é apt ç›´æ¥å®‰è£å³å¯ï¼š 
      ```bash
      # ä»¥å®‰è£ 535 ç‰ˆç‚ºä¾‹
      sudo apt install nvidia-driver-535
      ```
      å®‰è£å®Œä¹‹å¾Œé‡æ–°é–‹æ©Ÿï¼Œç„¶å¾Œé–‹å§‹ç¥ˆç¦±é›»è…¦èƒ½é †åˆ©é‡é–‹ã€‚
    * ç¢ºèªæ˜¯å¦å®‰è£æˆåŠŸï¼š
      ```
      # å¦‚æœä½ çš„é›»è…¦èƒ½å¤ é †åˆ©é‡é–‹
      nvidia-smi 
      ```
    * å¯ä»¥è€ƒæ…®å°‡é©…å‹•ç¨‹å¼çš„ç‰ˆæœ¬é–å®šèµ·ä¾†ï¼Œé¿å…ä»–è‡ªå‹•æ›´æ–°ï¼š
      ```bash
      sudo apt-mark hold nvidia-driver-535
      sudo apt-mark hold libnvidia-compute-535
      ```
* NVIDIA é©…å‹•ç¨‹å¼å°±æ˜¯è¸å…¥ ML é–‹ç™¼æœƒé‡åˆ°çš„ç¬¬ä¸€å€‹å¤©å‘ï¼Œå¾ˆæœ‰å¯èƒ½æŠŠ OS è£å¥½ä¹‹å¾Œï¼Œæ”¾ä¸€å€‹ NVIDIA Driver ä¸Šå»ï¼Œå°±å†ä¹Ÿæ‰“ä¸é–‹äº†ï¼Œé€™éƒ½æ˜¯å¾ˆå¸¸é‡åˆ°çš„äº‹æƒ…ã€‚
    * å»ºè­°æŠŠæ¨¡å‹æ¬Šé‡èˆ‡è¨“ç·´è³‡æ–™ç­‰ç­‰çš„ï¼Œéƒ½æ”¾åœ¨å¦å¤–ä¸€å€‹ç¡¬ç¢Ÿã€‚
    * å¦‚æœç³»çµ±ç‚¸é–‹ï¼Œæ¯”è¼ƒå¯ä»¥æ¯«ä¸çŒ¶è±«çš„é¸æ“‡é‡çŒï¼Œæœƒæ¯”èµ·ä½ è§£ç’°å¢ƒè¡çªä¾†çš„å¥½ä¸€äº›ã€‚
    * å»ºç«‹åœ¨ä½ èƒ½**ç›´æ¥ç®¡ç†æ©Ÿå™¨**ä»¥åŠ**æ©Ÿå™¨éš¨æ™‚éƒ½åœ¨ä½ æ—é‚Š**çš„ç‹€æ³ï¼Œåœ¨ä¸€äº›æ¬Šé™ç®¡ç†ç›¸å°åš´æ ¼ï¼Œæˆ–è€…è¨“ç·´æ©Ÿæˆ¿è·é›¢ä½ è¬é‡Œä¹‹é™çš„æƒ…æ³ä¸‹å°±å¾ˆéº»ç…©äº†ã€‚
    * å¦‚æœä½ é‚„èƒ½ä½¿ç”¨æ–‡å­—ä»‹é¢æ“ä½œæ©Ÿå™¨ï¼Œå»ºè­°å…ˆ[**å®Œæ•´åˆªé™¤ NVIDIA Driver**](https://hackmd.io/@PenutChen/NvDriverFighting) ç„¶å¾Œå†é‡æ–°å®‰è£ã€‚ (ç­†è€…ç­†è¨˜)

---

## Conda (è™›æ“¬ç’°å¢ƒç®¡ç†)
åœ¨ Python è™›æ“¬é–‹ç™¼ç’°å¢ƒä¸Šï¼Œç­†è€…æ¨è–¦ä½¿ç”¨ [Conda](https://docs.conda.io/en/latest/) å®¶æ—çš„ [Miniconda](https://docs.conda.io/projects/miniconda/en/latest/) ä¾†åšç®¡ç†ã€‚
* é›–ç„¶ Miniconda çš„è€å¤§å“¥ [Anaconda](https://www.anaconda.com/) éå»æœ‰äº›ä¸å¥½çš„è©•åƒ¹ï¼Œä½†å…¶å¯¦ç¶“éäº†è¨±å¤šå¹´çš„æ”¹é€²ã€ç¤¾ç¾¤çš„æ”¯æŒä»¥åŠ Miniconda çš„èª•ç”Ÿï¼Œç¾åœ¨çš„ Conda å·²ç¶“æ˜¯å€‹ç›¸ç•¶æ–¹ä¾¿å¥½ç”¨çš„å·¥å…·äº†ã€‚
* ä¸åƒ…èƒ½ç”¨ä¾†**ç®¡ç† Python å¥—ä»¶**ï¼Œä¹Ÿèƒ½**ç®¡ç† Python æœ¬èº«çš„ç‰ˆæœ¬**ä»¥åŠ **CUDA çš„ç‰ˆæœ¬**ä¹‹é¡çš„ã€‚

### å®‰è£ Miniconda
å‰å¾€ Miniconda çš„é é¢ä¸‹è¼‰å®‰è£æª”ä¸¦åŸ·è¡Œï¼Œä¸­é–“æœƒè©¢å•ä½ è¦å®‰è£åœ¨å“ªå€‹ä½ç½®ï¼Œé è¨­æ˜¯è£åœ¨ `~/miniconda3` è£¡é¢ã€‚
* ä½†ç­†è€…åå¥½è£åœ¨ `~/.miniconda3` è£¡é¢ï¼Œä¸€èˆ¬æª¢è¦–è³‡æ–™å¤¾æ™‚æœƒè¢«éš±è—èµ·ä¾†ã€‚
* å¦‚æœæ‰“ç®—åœ¨ Dockerfile è£¡é¢è£ Miniconda çš„è©±ï¼Œå¯ä»¥åŠ ä¸Š `-b` åƒæ•¸ä½¿ç”¨ã€‚å…¶ä»–é‚„æœ‰æ»¿å¤šå¯ç”¨çš„åƒæ•¸ï¼Œå¯ä»¥åœ¨åŸ·è¡Œå®‰è£ç¨‹å¼æ™‚åŠ ä¸Š `-h` ä¾†æŸ¥çœ‹ã€‚
* æœ€å¾Œå®‰è£ç¨‹å¼æœƒè©¢å•ä½ è¦ä¸è¦å° Shell åšåˆå§‹åŒ–ï¼Œå¦‚æœé¸æ“‡åšåˆå§‹åŒ–çš„è©±ï¼Œé‚£æ¯æ¬¡æ‰“é–‹ Shell çš„æ™‚å€™ï¼Œéƒ½æœƒå»è®€å– Conda çš„åˆå§‹åŒ–ç’°å¢ƒï¼Œæœ‰äº›æ™‚å€™æœƒé€ æˆåš´é‡çš„å»¶é²ã€‚
    * å¯ä»¥é¸æ“‡ä¸è¦åˆå§‹åŒ–ã€‚å¦‚æœå·²ç¶“åˆå§‹åŒ–éäº†ï¼Œå¯ä»¥åˆ° `~/.bashrc` è£¡é¢å°‡ `>>> conda initialize >>>` çš„å€å¡Šè¨»è§£æ‰å³å¯ã€‚
    * ä½†å¦‚æœä¸åšåˆå§‹ç•«æœƒä¸èƒ½ç›´æ¥ä½¿ç”¨ C\inda æŒ‡ä»¤ï¼Œé€™æ™‚å°±è¦é€é `source ~/miniconda3/bin/activate <env_name>` çš„æŒ‡ä»¤ä¾†å•Ÿç”¨è™›æ“¬ç’°å¢ƒã€‚

### Conda åŸºæœ¬æ“ä½œ
* å‰µå»ºè™›æ“¬ç’°å¢ƒä¸¦æŒ‡å®š Python ç‰ˆæœ¬ï¼š
    ```bash
    # ä½¿ç”¨ Python 3.9 çš„ç’°å¢ƒ
    conda create -n Hello39 python=3.9

    # ä½¿ç”¨ Python 3.10 çš„ç’°å¢ƒ
    conda create -n Hello310 python=3.10
    ```
* å•Ÿç”¨è™›æ“¬ç’°å¢ƒï¼š
    ```bash
    conda activate Hello
    ```
*  å®‰è£å¥—ä»¶ï¼š
    *  å¯ä»¥é€é `pip install` å®‰è£å¥—ä»¶ï¼Œä¹Ÿå¯ä»¥é€é `conda install` å®‰è£å¥—ä»¶ã€‚
        * ä½†ä¸¦ä¸æ˜¯æ¯å€‹å¥—ä»¶éƒ½æ”¯æ´å¾ Conda å®‰è£ï¼Œå»ºè­°åƒè€ƒè©²å¥—ä»¶çš„å®‰è£æ–¹æ³•ã€‚
    * ä¸€èˆ¬æƒ…æ³ä¸‹ï¼Œç­†è€…æœƒå„ªå…ˆé¸æ“‡ä½¿ç”¨ pip å®‰è£ï¼Œä½†æ˜¯åƒ [PyTorch](https://pytorch.org/get-started/locally/) é€™ç¨®å¥—ä»¶å°±æœ‰æ”¯æ´ä½¿ç”¨ conda å®‰è£çš„æ–¹æ³•ï¼š
        ```bash
        conda install pytorch pytorch-cuda=12.1 -c pytorch -c nvidia
        ```
    * å¦‚æœå‰µå»ºè™›æ“¬ç’°å¢ƒæ™‚ï¼Œå¿˜è¨˜é™„ä¸Š `python=X.YY` çš„åƒæ•¸ï¼Œä¹Ÿå¯ä»¥è£å›ä¾†ï¼š
        ```bash
        conda install python=3.10
        ```
* é›¢é–‹è™›æ“¬ç’°å¢ƒï¼š
    ```bash
    conda deactivate
    ```
* æŸ¥çœ‹æœ‰å“ªäº›è™›æ“¬ç’°å¢ƒï¼š
    ```bash
    conda env list
    ```
* ç§»é™¤ä¸éœ€è¦çš„è™›æ“¬ç’°å¢ƒï¼š
    ```bash
    conda env remove -n Hello310
    ```
* æ¸…é™¤ Conda çš„å¿«å–ï¼š (ä¾‹å¦‚å®‰è£å¥—ä»¶çš„å£“ç¸®æª”)
    ```bash
    conda clean -a  # ç§»é™¤æ‰€æœ‰ç›¸é—œå¿«å–
    ```

### Conda é€²éšæ“ä½œ
* å°ç’°å¢ƒé€²è¡Œå‚™ä»½èˆ‡è¤‡è£½ï¼š
    ```bash
    # å°‡ç’°å¢ƒè³‡è¨Šè¼¸å‡ºç‚º YAML æª”
    conda env export > environment.yaml
    # å¾ YAML æª”è¤‡è£½ç’°å¢ƒ
    conda env create -f environment.yaml

    # å°‡ç’°å¢ƒè³‡è¨Šè¼¸å‡ºç‚º TXT æª”
    conda list --explicit > requirements.txt
    # å¾ TXT æª”è¤‡è£½ç’°å¢ƒ
    conda create --name HelloCopy --file requirements.txt

    # ç›´æ¥è¤‡è£½ç’°å¢ƒ
    conda create --name HelloCopy --clone Hello
    ```
* é€é Revision åŠŸèƒ½æ“ä½œç’°å¢ƒçš„ç‰ˆæœ¬
    * ä½†æ˜¯ Conda çš„ Revision åªæœƒç´€éŒ„ `conda install` ç›¸é—œçš„è®ŠåŒ–
    ```bash
    conda list --revisions  # æŸ¥çœ‹æœ‰å“ªäº›ç‰ˆæœ¬ç´€éŒ„
    conda install --revision 7  # Rollback å›ç¬¬ 7 ç‰ˆ
    ```
* å…¶å¯¦åœ¨ Python å¥—ä»¶ç®¡ç†ä¸Šï¼Œé‚„æœ‰å€‹ç›¸ç•¶å—æ­¡è¿çš„ [Poetry](https://python-poetry.org/) å¥—ä»¶ã€‚
    * ä½†æ˜¯ Poetry ä¸¦ä¸æ¶‰åŠ CUDA é€™ç¨®ç³»çµ±å·¥å…·çš„ç®¡ç†ï¼Œå› æ­¤ä¹Ÿèƒ½ç”¨ Conda ç®¡ç†ç³»çµ±å·¥å…·ï¼Œä¸¦åœ¨ Conda çš„è™›æ“¬ç’°å¢ƒè£¡é¢ä½¿ç”¨ Poetry ä¹‹é¡çš„ã€‚

---

## å¸¸ç”¨å¥—ä»¶å®‰è£
ä»‹ç´¹ä¸€äº›ç¶“å¸¸æœƒç”¨åˆ°çš„å¥—ä»¶æˆ–å·¥å…·çš„å®‰è£æ–¹æ³•ã€‚

### CMake å®‰è£
åœ¨å®‰è£å¥—ä»¶çš„éç¨‹ï¼Œç¶“å¸¸æœƒéœ€è¦ç”¨åˆ° [CMake](https://cmake.org/) é€™å€‹ç·¨è­¯å·¥å…·ã€‚
* ä½†å¾ˆå¤šå¥—ä»¶éƒ½æœƒè¦æ±‚ä½  CMake è£åˆ° 3.2X ç‰ˆä»¥ä¸Šï¼Œå¦‚æœä½ æ˜¯ Ubuntu 20.04 ä¹‹é¡çš„ï¼Œé€é `apt` å®‰è£çš„ CMake åªèƒ½åˆ° 3.16 è€Œå·²ã€‚
* å®‰è£è£åˆ°æ›´é«˜çš„ç‰ˆæœ¬ï¼š
  ```
  # ç”¨ pip å®‰è£ cmake æ ¹æœ¬é‚ªæ•™ï¼Œä½†æ˜¯çœŸçš„å¤ªæ–¹ä¾¿äº†ï¼
  pip install cmake
  ```

---

## CUDA
CUDA æ˜¯æ·±åº¦å­¸ç¿’ç›¸ç•¶é‡è¦çš„æŠ€è¡“ï¼Œåˆ†æˆ [Runtime èˆ‡ Toolkit](https://stackoverflow.com/a/53504578) å…©ç¨®ï¼Œå¦‚æœåªæ˜¯è¦é‹è¡Œç¨‹å¼ç”¨ CUDA Runtime å³å¯ä½†æ¶‰åŠç·¨è­¯è¡Œç‚ºæ™‚å°±æœƒç”¨åˆ° CUDA Toolkitã€‚
* éœ€è¦é—œæ³¨ NVIDIA Driver èˆ‡ CUDA Toolkit çš„[ç‰ˆæœ¬å°æ‡‰](https://docs.nvidia.com/cuda/cuda-toolkit-release-notes/index.html#id6)ã€‚
    * Driver çš„ç‰ˆæœ¬èˆ‡ CUDA çš„ç‰ˆæœ¬ç¿’ç¿’ç›¸é—œï¼Œå…©è€…åŸºæœ¬ä¸Šéƒ½å‘ä¸‹ç›¸å®¹ã€‚
      > `NVIDIA Driver æ”¯æ´çš„ CUDA ç‰ˆæœ¬` â‰§ `CUDA Toolkit ç‰ˆæœ¬` â‰§` é–‹ç™¼æ‡‰ç”¨çš„ CUDA éœ€æ±‚ç‰ˆæœ¬`
* ä¸€èˆ¬ä¾†èªªæœƒå»ºè­°è®“ CUDA Toolkit (ç’°å¢ƒ) èˆ‡ç¨‹å¼çš„ CUDA éœ€æ±‚ä¸€æ¨£ï¼Œå› ç‚º **Conda å¯ä»¥ç®¡ç† CUDA çš„ç‰ˆæœ¬**ã€‚
    ```bash
    $ conda env list

    # conda environments:
    #
    base
    py311cu118
    py311cu121
    py312cu121
    ...
    ```
* æ¨è–¦å¯ä»¥åƒè€ƒ [PyTorch å®˜ç¶²](https://pytorch.org/get-started/locally/)ç›®å‰æ”¯æ´åˆ°å“ªå€‹ç‰ˆæœ¬ï¼Œä¾†æ±ºå®šè¦å®‰è£å“ªå€‹ CUDA ç‰ˆæœ¬ã€‚
    * å› ç‚ºå¾ˆå¤šå¥—ä»¶é–‹ç™¼è€…ä¹Ÿéƒ½æ˜¯è·Ÿéš¨ PyTorch çš„ç‰ˆæœ¬åœ¨è·‘ã€‚
    * åªæ˜¯åƒè€ƒï¼Œä¸€åˆ‡ä»¥æ‡‰ç”¨éœ€æ±‚ç‚ºä¸»ã€‚
* å¯ä»¥åœ¨ Anaconda çš„[é é¢](https://anaconda.org/nvidia/cuda-toolkit)ä¸ŠæŸ¥çœ‹ç›®å‰å¯ä»¥å®‰è£å“ªäº›ç‰ˆæœ¬çš„ CUDA å¯ä»¥å®‰è£ã€‚
    ```bash
    # å®‰è£æ¨™ç±¤ç‚º nvidia/label/cuda-12.1.1 çš„ cuda å¥—ä»¶ã€‚
    
    conda install -y nvidia/label/cuda-12.1.1::cuda
    ```
* é™¤äº† `cuda` ä»¥å¤–ï¼Œé‚„æœ‰å€‹åç¨±ç‚º `cuda-toolkit` çš„å¥—ä»¶ï¼Œå…©è€…å…¶å¯¦éƒ½æœƒå¹«ä½ å®‰è£ CUDA å‡½å¼åº«ã€‚
    * é¸æ“‡å®‰è£ `cuda` å¥—ä»¶çš„è©±ï¼Œæœƒæ¯” `cuda-toolkit` å¤šå‡º `cuda`, `cuda-demo-suite`, `cuda-runtime` ç­‰ä¸‰å€‹é …ç›®ã€‚
    * å¯¦éš›ä¸Šåªæœ‰ `cuda-demo-suite` å¥—ä»¶æœƒå¤šå®‰è£ä¸€äº›æ–°æª”æ¡ˆã€‚
    * ä¸ç®¡å®‰è£ `cuda` æˆ– `cuda-toolkit` éƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ¨è–¦æŒ‰ç…§ [NVIDIA å®˜æ–¹æ–‡ä»¶](https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html#conda-installation)çš„å»ºè­°å®‰è£ `cuda` å¥—ä»¶å³å¯ã€‚
* æœ‰æ™‚å…¶ä»–å¥—ä»¶æœƒéœ€è¦è‡ªè¡Œç·¨è­¯ä¸€äº› CUDA å‡½å¼åº«ã€‚
    * ä¾‹å¦‚å¸¸ç”¨çš„åˆ†æ•£å¼è¨“ç·´æ¡†æ¶ [DeepSpeed](https://github.com/microsoft/DeepSpeed)ï¼Œå®ƒå¯èƒ½æœƒå»æœå°‹ç’°å¢ƒåº•ä¸‹çš„ `lib64` è€Œä¸æ˜¯ `lib` è³‡æ–™å¤¾ï¼Œä½† Conda é€šå¸¸æ˜¯æŠŠç›¸é—œå‡½å¼åº«å®‰è£åœ¨ `lib` è£¡é¢ã€‚
        ```bash
        # å¯ä»¥ç›´æ¥ Link éå»ï¼š
        
        ln -s ~/.miniconda3/envs/env_name/lib ~/.miniconda3/envs/env_name/lib64
        ```

---

## NVCC èˆ‡ cuDNN å®‰è£
[NVCC](https://anaconda.org/nvidia/cuda-nvcc) èˆ‡ [cuDNN](https://anaconda.org/conda-forge/cudnn) é€™é¡çš„å·¥å…·å’Œå‡½å¼åº«ä¹Ÿèƒ½é€é Conda å®‰è£ï¼Œå‰è€…é€šå¸¸æœƒè·Ÿè‘— CUDA ä¸€èµ·å®‰è£ã€‚
* å»ºè­°å…ˆè£ cuDNN å†è£ CUDAã€‚
    ```bash
    conda install -y anaconda::cudnn
    conda install -y nvidia/label/cuda-12.1.1::cuda
    conda install -y pytorch pytorch-cuda=12.1 -c pytorch -c nvidia
    ```
* å®‰è£æ˜¯å¦æ­£ç¢ºï¼š
    ```bash
    $ nvcc -V

    nvcc: NVIDIA (R) Cuda compiler driver
    Copyright (c) 2005-2023 NVIDIA Corporation
    Built on Mon_Apr__3_17:16:06_PDT_2023
    Cuda compilation tools, release 12.1, V12.1.105
    Build cuda_12.1.r12.1/compiler.32688072_0
    ```
* è‹¥å…ˆè£ CUDA å†è£ cuDNN å¾Œï¼Œé‡æ–°èª¿ç”¨ PyTorch å¯èƒ½æœƒé‡åˆ°ä»¥ä¸‹å•é¡Œ:
    ```bash
    Traceback (most recent call last):
      File "/home/user/lab/script.py", line 1, in <module>
        import torch
      File "/home/user/.miniconda3/envs/Py310/lib/python3.10/site-packages/torch/__init__.py", line 229, in <module>
        from torch._C import *  # noqa: F403
    ImportError: /home/user/.miniconda3/envs/Py310/lib/python3.10/site-packages/torch/lib/libtorch_cuda.so: undefined symbol: cudaGraphInstantiateWithFlags, version libcudart.so.11.0
    ```
    å› ç‚ºå¾ Conda å®‰è£ cuDNN æ™‚ï¼Œç³»çµ±å¾ˆã€Œç†±å¿ƒã€çš„å¹«æˆ‘å€‘å¤šè£äº†ä¸€å€‹ CUDA çš„å‡½å¼åº«
    ```bash
    $ cd ~/.miniconda3/envs/py310/lib
    $ ll | grep cuda

    -rw-rw-r-- 1.2K cudatoolkit_config.yaml
    -rw-rw-r-- 832K libcudadevrt.a
    lrwxrwxrwx   21 libcudart.so -> libcudart.so.11.3.109
    lrwxrwxrwx   21 libcudart.so.11.0 -> libcudart.so.11.3.109
    -rwxrwxr-x 623K libcudart.so.11.3.109
    -rwxrwxr-x 680K libcudart.so.11.8.89
    -rw-rw-r-- 1.2M libcudart_static.a
    ```
    åŸæœ¬æ‡‰è©²æ˜¯ CUDA 11.8 çš„ç’°å¢ƒï¼Œè¢« Link æˆ 11.3 äº†ï¼Œä½†å› ç‚ºç•¶åˆ PyTorch æ˜¯å®‰è£ CUDA 11.8 çš„ç‰ˆæœ¬ï¼Œæ‰€ä»¥æ‰æœƒå ±éŒ¯ã€‚
* æ‰‹å‹•è§£æ±ºé€™å€‹å•é¡Œï¼ŒæŠŠä¸æ­£ç¢ºçš„é€£çµåˆªæ‰ï¼Œé‡æ–°é€£çµæ­£ç¢ºçš„å‡½å¼åº«å³å¯ã€‚
    ```bash
    rm libcudart.so.11.0 libcudart.so
    ln -s libcudart.so.11.8.89 libcudart.so.11.0
    ln -s libcudart.so.11.8.89 libcudart.so
    ```

---

## NVCC
[NVCC](https://docs.nvidia.com/cuda/cuda-compiler-driver-nvcc/) å…¶å¯¦æ˜¯å€‹ç·¨è­¯ç”¨çš„å·¥å…·ï¼Œæˆ‘å€‘å¯ä»¥ä½¿ç”¨ C èªè¨€æ’°å¯«ä¸€äº› CUDA å°å·¥å…·ä¾†ç”¨ã€‚
* æŸ¥çœ‹ GPU çš„ CUDA ç›¸å®¹æ€§ï¼š
    ```cpp!
    // DemoCUDA.cpp
    // Include Path: ~/.miniconda3/envs/env_name/include/**

    #include <cuda_runtime.h>
    #include <stdio.h>

    int main() {
        int nDevices;
        cudaGetDeviceCount(&nDevices);

        for (int i = 0; i < nDevices; i++) {
            cudaDeviceProp p;
            cudaGetDeviceProperties(&p, i);

            printf("Device %d\n", i);
            printf("  Device Name: %s\n", p.name);
            printf("  CUDA Capability: %d.%d\n", p.major, p.minor);
        }

        return 0;
    }
    ```
    é€éä»¥ä¸‹æŒ‡ä»¤ç·¨è­¯ä¸¦åŸ·è¡Œï¼š
    ```bash
    $ nvcc DemoCUDA.cpp -o DemoCUDA && ./DemoCUDA
    
    Device 0
      Device Name: NVIDIA GeForce RTX 3090
      CUDA Capability: 8.6
    ```
    * é€™å€‹ [CUDA Capability](https://developer.nvidia.com/cuda-gpus) åœ¨ä½¿ç”¨æŸäº›æ¯”è¼ƒå…ˆé€²çš„é«˜é€Ÿé‹ç®—æ™‚æœƒæœ‰å½±éŸ¿ã€‚
        * ä¾‹å¦‚ï¼Œæ¯”è¼ƒæ—©æœŸçš„é¡¯å¡å¯èƒ½å°±ä¸æ”¯æ´å¿«é€Ÿçš„ 8-Bit çŸ©é™£é‹ç®—ï¼Œåœ¨ä¸€äº›ä½¿ç”¨é‡åŒ– (Quantization) æŠ€è¡“çš„æ‡‰ç”¨è£¡é¢ï¼Œé€Ÿåº¦å„ªå‹¢å°±æœƒç›¸å°å°ä¸€é»ã€‚
* é›–ç„¶ `nvidia-smi` å·²ç¶“æœ‰æä¾›äº†ï¼Œä½†æˆ‘å€‘å¯ä»¥é€é [NVML](https://developer.nvidia.com/nvidia-management-library-nvml) ä¾†æ’°å¯«å–å¾—é¡¯å¡æº«åº¦çš„ç¨‹å¼ã€‚
    * å®‰è£ NVML å‡½å¼åº«ï¼š
        ```bash
        conda install -c conda-forge nvidia-ml
        ```
    * æ’°å¯«å–å¾—æº«åº¦çš„ç¨‹å¼ç¢¼ï¼š
        ```cpp
        #include <nvml.h>
        #include <stdio.h>

        int main() {
            nvmlInit();
            unsigned int device_count;
            nvmlDeviceGetCount(&device_count);

            for (int i = 0; i < device_count; i++) {
                unsigned int temp;
                nvmlDevice_t device;
                nvmlDeviceGetHandleByIndex(i, &device);
                nvmlDeviceGetTemperature(device, NVML_TEMPERATURE_GPU, &temp);
                printf("Device %d - GPU Temperature: %u C\n", i, temp);
            }

            nvmlShutdown();

            return 0;
        }
        ```
    * ç·¨è­¯ç¨‹å¼ç¢¼ï¼š
      é€™è£¡å¯ä»¥ç›´æ¥ç”¨ `gcc` ç·¨è­¯ï¼Œåœ¨ç·¨è­¯ä¹‹å‰ï¼Œè¦å…ˆç¢ºèª `nvml.h` èˆ‡ `nvidia-ml.so` çš„æ‰€åœ¨è·¯å¾‘ï¼š
        ```bash
        $ find ~/.miniconda3/envs/env_name | grep nvml.h
        $ find ~/.miniconda3/envs/env_name | grep nvidia-ml.so
        
        ~/.miniconda3/envs/env_name/include/nvml.h
        ~/.miniconda3/envs/env_name/lib/stubs/libnvidia-ml.so
        ```
      ç·¨è­¯æ™‚ï¼Œå‰è€…è¦æ”¾åœ¨åƒæ•¸ `-I` å¾Œé¢ï¼Œå¾Œè€…çš„**è³‡æ–™å¤¾**ï¼ˆä¸éœ€è¦ .soï¼‰è¦æ”¾åœ¨ `-L` å¾Œé¢ï¼Œå®Œæ•´çš„ç·¨è­¯æŒ‡ä»¤å¦‚ä¸‹ï¼š
        ```bash
        gcc \
            -L ~/.miniconda3/envs/env_name/lib/stubs \
            -I ~/.miniconda3/envs/env_name/include \
            DemoNVML.cpp -o DemoNVML -l nvidia-ml
        ```
    * åŸ·è¡Œ DemoNVML çµæœå¦‚ä¸‹ï¼š
        ```bash
        Device 0 - GPU Temperature: 55 C
        ```

---

## Docker
è‹¥æ˜¯ç†Ÿæ‚‰ Docker çš„é–‹ç™¼è€…ï¼Œå¯ä»¥é¸æ“‡ä½¿ç”¨ PyTorch å®˜æ–¹çš„ Image é€²è¡Œé–‹ç™¼ã€‚
* ä½¿ç”¨å®˜æ–¹ Docker Image çš„å¥½è™•åœ¨æ–¼ CUDA ç›¸é—œçš„å·¥å…·éƒ½å·²ç¶“é…ç½®å¥½äº†ï¼Œä¸å¤ªéœ€è¦æ“”å¿ƒç’°å¢ƒé…ç½®ç‚¸é–‹çš„å•é¡Œã€‚
* ä¹Ÿèƒ½å¤ é€²ä¸€æ­¥é€é Dockerfile ä¾†æ§åˆ¶é–‹ç™¼ç’°å¢ƒæ‰€ä¾è³´çš„å¥—ä»¶ï¼Œç„¡è«–æ˜¯éœ€è¦é€é pip æˆ– apt å®‰è£çš„å¥—ä»¶ï¼Œä½¿ç’°å¢ƒå»ºç½®æ›´å®¹æ˜“è¢«é‡ç¾ã€‚

### PyTorch æ˜ åƒæª”
PyTorch å®˜æ–¹çš„ Image Tags å€åˆ†ç‚º `runtime` èˆ‡ `devel` å…©ç¨®ã€‚
* `runtime` : ç”¨åœ¨é‹è¡Œå·²é–‹ç™¼å¥½çš„æ‡‰ç”¨ã€‚
* `devel` : é–‹ç™¼ä½¿ç”¨ã€‚
    * Dockerfileï¼š
        ```dockerfile
        FROM pytorch/pytorch:2.3.0-cuda12.1-cudnn8-devel
        RUN pip install transformers
        ```
    * å°‡ä»¥ä¸Š Dockerfile å»ºæˆ Image
        ```
        docker build-t torch-dev:last .
        ```

### Tensorflow æ˜ åƒæª”
* è‹¥æ˜¯ Tensorflow ç›¸é—œçš„é–‹ç™¼ï¼Œå‰‡å¯ä»¥è€ƒæ…®ï¼š
    ```
    tensorflow/tensorflow:2.15.0-gpu 
    
    # é™„å¸¶äº† Jupyter é–‹ç™¼ç’°å¢ƒå¯ä»¥ä½¿ç”¨ï¼Œç›¸å°å¥½ä¸Šæ‰‹ä¸€äº›ã€‚
    tensorflow/tensorflow:2.15.0-gpu-jupyter
    ```

### Docker Container é–‹ç™¼
å¯é€æœ VS Code çš„ [Dev Containers](https://tinyurl.com/llm-dev-containers) å¤–æ›ä¾†é ç«¯é€²å…¥å®¹å™¨å…§ã€‚
* å°‡å®¹å™¨è·‘èµ·ä¾†ï¼š
    ```bash
    docker run --name torch-dev -itd --gpus all \
        -v $PWD:/workspace torch-dev:latest
    ```
    å°‡ç•¶å‰å·¥ä½œç›®éŒ„æ›è¼‰åˆ°å®¹å™¨å…§çš„ `/workspace` è·¯å¾‘ï¼Œæ¥è‘—æ‰“é–‹å·¦é‚Šçš„ Remote Explorer åˆ†é ï¼Œå³éµé»é¸å‰›å‰›å»ºç«‹çš„å®¹å™¨ï¼Œç„¶å¾Œé¸æ“‡ `"Attach in New Window"` å³å¯åœ¨å®¹å™¨ä¸­é–‹ç™¼ã€‚
* å®¹å™¨å…§ç›´æ¥å°±æ˜¯**æœ€é«˜æ¬Šé™ (Root)**ï¼Œè¦ç‰¹åˆ¥æ³¨æ„ï¼Œåœ¨å®¹å™¨å…§å»ºç«‹çš„æª”æ¡ˆï¼Œå°æ‡‰åˆ°ä¸»æ©Ÿè£¡é¢ä¹Ÿæœƒæ˜¯æœ€é«˜æ¬Šé™ã€‚
    * åœ¨ä¸»æ©Ÿèˆ‡å®¹å™¨ä¹‹é–“äº¤éŒ¯æ“ä½œçš„è©±ï¼Œè¦ç‰¹åˆ¥å¿ƒè™•ç†æ¬Šé™å•é¡Œã€‚

---

## Colab
å¦‚æœä½ å·²ç¶“å­å€¦äº†èˆ‡ Python ç’°å¢ƒå¥®é¬¥ï¼Œæ¯æ¬¡ä¸€å€‹æ–°çš„å¯¦é©—éƒ½è¦æ­ä¸€å€‹ç’°å¢ƒåšæ¸¬è©¦ï¼Œæœ‰çš„å¯¦é©—å¯èƒ½ä¹Ÿå­˜æ´»ä¸äº†ä¸€å…©å¤©ï¼Œä¸å¦¨è©¦è©¦çœ‹ [Google Colab](https://colab.research.google.com/) ç­†è¨˜æœ¬ã€‚
* Colab çš„ä»‹é¢èˆ‡ [Jupyter Notebook](https://jupyter.org/) å¾ˆç›¸ä¼¼ï¼Œä½†é‹ç®—æ˜¯è·‘åœ¨ Google çš„æ©Ÿå™¨ä¸Šé¢ã€‚
* Google éå¸¸å¤§æ–¹çš„å…è²»å€Ÿæˆ‘å€‘ä¸€å¼µ [Tesla T4](https://www.nvidia.com/zh-tw/data-center/tesla-t4/) GPU ä½¿ç”¨ï¼Œé›–ç„¶åªæœ‰ 16 GB çš„ GPU è¨˜æ†¶é«”ï¼Œä½†æ˜¯åšä¸€äº›å°å‹å¯¦é©—å·²ç¶“ç›¸ç•¶å¤ ç”¨ã€‚
    * åœ¨é€™å€‹ç’°å¢ƒè£¡é¢ï¼Œå®Œå…¨ä¸ç”¨ç…©æƒ± NVIDIA Driver èˆ‡ CUDA çš„å•é¡Œã€‚
    * é‡é»æ˜¯ï¼Œé‚£å€‹ç’°å¢ƒçš„ç¶²è·¯é€Ÿåº¦æœ‰å¤ å¿«çš„å•¦ï¼
        * é›¢å³°æ™‚æ®µç¶²é€Ÿç¶“å¸¸ç ´ç™¾ MB/sï¼Œå¹³å‡ä¹Ÿæœ‰å€‹äº”å…­å MB/s ä»¥ä¸Šï¼Œå°æ–¼ç¶“å¸¸åœ¨ä¸‹è¼‰å¤§æ¨¡å‹çš„ ML é–‹ç™¼è€…è€Œè¨€ï¼Œæ˜¯å€‹ç›¸ç•¶æ–¹ä¾¿çš„ç¶²è·¯ç’°å¢ƒã€‚
* ç¼ºé»ï¼š
  ä¸èƒ½åœ¨è£¡é¢æ“ä½œ Dockerï¼Œå€‹äººçŒœæ¸¬ Colab æœ¬èº«æ‡‰è©²ä¹Ÿæ˜¯å®¹å™¨æœå‹™çš„ç·£æ•…ã€‚
* åœ¨ Colab è£¡é¢å®‰è£å…¶ä»–å¥—ä»¶ï¼š (åŒ Jupyter)
    ```ipynb
    !pip install transformers
    ```
* ä½¿ç”¨ T4 GPUï¼š
    * åœ¨ä¸Šæ–¹é¸å–®çš„ã€ŒåŸ·è¡Œéšæ®µ > è®Šæ›´åŸ·è¡Œéšæ®µé¡å‹ã€é¸æ“‡ T4 GPUã€‚
    * ä¹Ÿæœ‰ TPU ä¹‹é¡çš„å¯ä»¥é¸ï¼Œä½†æ˜¯ TPU çš„ç”¨æ³•è·Ÿä¸€èˆ¬ GPU ä¸å¤ªä¸€æ¨£ã€‚
* è¨­å®šè£¡é¢é‚„æœ‰è²“è²“ç‹—ç‹—æ¨¡å¼è·Ÿçˆ†ç‚¸ç‰¹æ•ˆå¯ä»¥é¸æ“‡ï¼Œæ›¿æ²‰æ‚¶çš„é–‹ç™¼éç¨‹å¢æ·»ä¸€é»æ´»æ½‘çš„æ°£æ°›ï¼š
![1MgKeTh](https://hackmd.io/_uploads/ryc6pt-bxl.png)
* é™åˆ¶ï¼š
    * å…è²»ç‰ˆçš„ GPU åªæœ‰ 16 GB å¯ä»¥ç”¨ï¼Œè®€å– LLM å‹¢å¿…éœ€è¦é€²è¡Œé‡åŒ– (Quantization)
    * åªè¦ç­†è¨˜æœ¬é–’ç½®ä¸€æ®µæ™‚é–“å°±æœƒè¢«ä¸­æ–·é€£ç·šã€‚
    * é€£çºŒé‹ä½œæ™‚é–“é€šå¸¸ä¹Ÿä¸èƒ½è¶…éåŠå¤©ã€‚
    * å¦‚æœæƒ³è¦æ›´é•·æ™‚é–“çš„ä½¿ç”¨ï¼Œæˆ–è€…èª¿ç”¨æ›´é«˜ç´šçš„é¡¯å¡ï¼Œå¯ä»¥è€ƒæ…®è³¼è²· [Colab Pro](https://colab.research.google.com/signup) æœƒå“¡è³‡æ ¼ã€‚
* æ¯”è¼ƒé©åˆé‚£ç¨®ä¸€å…©å€‹å°æ™‚å°±èƒ½çµæŸçš„å°å‹å¯¦é©—ï¼Œæˆ–è€…è¦å¯« Demo Code çµ¦åˆ¥äººçœ‹çš„æ™‚å€™èƒ½æ–¹ä¾¿åˆ†äº«ã€‚

---

## GPU
GPU å‹è™Ÿçš„è³‡è¨Šã€‚
* åœ¨ NVIDIA åº•ä¸‹çš„ GPUï¼Œæ¯ä¸€ä»£çš„æ¶æ§‹éƒ½æœƒæœ‰å€‹ä»£è™Ÿï¼Œé€™äº›ä»£è™Ÿéƒ½åœ¨å‘æ•¸å­¸èˆ‡è³‡è¨Šå²ä¸Šçš„åäººè‡´æ•¬ã€‚
    * ä¾‹å¦‚ï¼š
        * GTX 10 é–‹é ­çš„é¡¯å¡æ˜¯ Pascal æ¶æ§‹
        * RTX 20 é–‹é ­çš„é¡¯å¡æ˜¯ Turing æ¶æ§‹
        * RTX 30 é–‹é ­çš„é¡¯å¡æ˜¯ Ampere æ¶æ§‹
        * RTX 40 é–‹é ­çš„é¡¯å¡æ˜¯ Ada Lovelace æ¶æ§‹
* ä½œç‚ºæ·±åº¦å­¸ç¿’é ˜åŸŸçš„é–‹ç™¼è€…ï¼Œé¸è³¼é¡¯å¡æ™‚é™¤äº†é‹ç®—é€Ÿåº¦ä¸åŒï¼Œæ›´é‡è¦çš„æ˜¯é¡¯å¡çš„è¨˜æ†¶é«”ï¼Œå¦‚æœæ¨¡å‹æ”¾ä¸ä¸‹ï¼Œç®—çš„å†å¿«éƒ½æ˜¯ç™½æ­ã€‚
* æ¶ˆè²»ç­‰ç´šçš„é¡¯å¡ï¼Œå…¶ GPU è¨˜æ†¶é«”æœ€é«˜éƒ½åªåšåˆ° 24 GB è€Œå·²ã€‚
    * ä¾‹å¦‚ RTX 3090, RTX 4090
* å·¥ä½œç«™ç­‰ç´šçš„é¡¯å¡ã€‚(>æ¶ˆè²»ç­‰ç´š)
    * ç¾ä»Šæœ€æœ‰åçš„å°±æ˜¯ A100ã€‚
    * å…¶ä»–é‚„æœ‰ [RTX A6000](https://www.nvidia.com/zh-tw/design-visualization/rtx-a6000/), [RTX 6000 Ada](https://www.nvidia.com/zh-tw/design-visualization/rtx-6000/) é€™ç¨® 48 GB ç´šçš„ï¼Œå’Œ A100 çš„ç¹¼ä»»è€… [H100](https://www.nvidia.com/zh-tw/data-center/h100/) ç­‰é€™äº›è¨“ç·´ç”¨çš„é¡¯å¡ã€‚
    * é‚„æœ‰ [L40S](https://www.nvidia.com/zh-tw/data-center/l40s/) é€™ç¨®æ¨è«–å„ªåŒ–çš„é¡¯å¡ã€‚
    * **ä½†ç„¡è«–å“ªä¸€ç¨®ï¼Œéƒ½ä¸æ˜¯ä¸€èˆ¬äººè²·å¾—èµ·çš„ ğŸ’¸ğŸ’¸ğŸ’¸**
        > é›–ç„¶ç¾åœ¨é€™äº›é¡¯å¡éå¸¸ç¼ºè²¨ï¼Œæœ‰éŒ¢ä¹Ÿè²·ä¸èµ·ï¼Œåªèƒ½èªªè€é»ƒè³ºçˆ›äº† ğŸ’°

### A100
[A100](https://www.nvidia.com/zh-tw/data-center/a100/) ç‚º [V100](https://www.nvidia.com/zh-tw/data-center/v100/) çš„ç¹¼ä»»è€…ï¼Œæ¡ç”¨ Ampere æ¶æ§‹ï¼Œæœ‰ 40 GB/80 GB å…©ç¨®è¦æ ¼çš„ GPU è¨˜æ†¶é«”ã€‚
* æœ‰è¶£çš„æ˜¯ä»–èƒ½åˆ‡å‰²è¨˜æ†¶é«”ï¼Œä¸€å¼µ A100 çœ‹èµ·ä¾†æœƒåƒæœ‰ 7 å¼µ GPU ä¸€æ¨£ï¼š
![15WtIqy](https://hackmd.io/_uploads/BJ2Dy6b-el.png)
ä¸Šåœ–æ˜¯ä¸€å°å››å¼µ A100 çš„æ©Ÿå™¨ï¼Œå…¶ä¸­ 4 è™Ÿé¡¯å¡è¢«åˆ‡æˆ 7 ä»½çš„æ¨£å­ã€‚

---

## é€£çµ
* [Ada GPU ä»‹ç´¹](https://www.ithome.com.tw/review/158433)
* [ChatGPT: CUDA & NVML](https://chat.openai.com/share/a996d8c8-8315-4784-9c3d-758685e32f2e)

---

## çµè«–
* æ¶è¨­èˆ‡ç®¡ç†ç’°å¢ƒçš„æ–¹æ³•ï¼Œä¸­é–“é‚„å¾ˆç†±è¡€çš„å¯«èµ·äº† CUDA å°ç¨‹å¼ï¼Œä¸¦ä»‹ç´¹äº† Colab èˆ‡ä¸€äº› NVIDIA é¡¯å¡çš„è³‡è¨Šã€‚
* æ¯å€‹äººéƒ½æœ‰è‡ªå·±çš„ä¸€å¥—ç®¡ç†æ–¹æ³•ï¼Œåªè¦è‡ªå·±èƒ½å¤ è¼•é¬†é§•é¦­ï¼Œè€Œä¸”æ–¹ä¾¿é…åˆåœ˜éšŠå³å¯ã€‚

---